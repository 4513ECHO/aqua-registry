# Contributing

About how to write [registry.yaml](registry.yaml), please see [Registry Configuration](https://aquaproj.github.io/docs/reference/registry-config).

## Requirements

- Go

You can install Go with aqua.

```console
$ aqua g -i golang/go
$ aqua i -l
$ go version
```

## Helper tools written in Go

We provide helper tools written in Go.

- scaffold: Scaffold a package configuration
- generate-registry
- create-pr-new-pkg

### scaffold

aqua >= v1.14.0 is required.

```console
$ go run ./cmd/scaffold <package name>
```

e.g.

```console
$ go run ./cmd/scaffold cli/cli
```

This tool does the following things.

1. Scaffold configuration files.
1. Install packages for testing

--

1. Create directories `pkgs/<package name>`
1. Create `pkgs/<package name>/pkg.yaml` and `pkgs/<package name>/registry.yaml`

e.g. cli/cli

- [pkg.yaml](pkgs/cli/cli/pkg.yaml)
- [registry.yaml](pkgs/cli/cli/registry.yaml)

3. Update `registry.yaml`
4. Create or update `aqua.yaml`
5. `aqua g -i <package name>`
6. `aqua i`

### generate-registry

[registry.yaml on the repository root directory](registry.yaml) is generated by [cmd/generate-registry/main.go](cmd/generate-registry/main.go).
Don't edit it manually, and if you update `registry.yaml` in [pkgs](pkgs) directory, don't forget to run generate-registry.

No argument is needed.

```console
$ go run ./cmd/generate-registry
```

### create-pr-new-pkg

:warning: This tool is useful but if you dislike this tool, you don't have to use this tool.

```console
$ go run ./cmd/create-pr-new-pkg <package name>...
```

e.g.

```console
$ go run ./cmd/create-pr-new-pkg cli/cli
```

This tool does the following things.

1. Create a feature branch
1. Create a commit
1. Push the commit to origin
1. Open a web browser to create a request with GitHub CLI

## How to add packages

1. Scaffold configuration: `go run ./cmd/scaffold <package name>`
1. Update generated files
1. Update registry.yaml: `go run ./cmd/generate-registry`
1. Create a pull request: `go run ./cmd/create-pr-new-pkg <package name>...`

## Style Guide

https://aquaproj.github.io/docs/reference/registry-style-guide

## Supported OS and CPU Architecture

Please consider the following OS and CPU Architecture.

- OS
  - windows
  - darwin
  - linux
- CPU Architecture
  - amd64
  - arm64

We test the registry in CI on the above environments by GitHub Actions' build matrix.

## Test multiple versions

If the package has the field [version_overrides](https://aquaproj.github.io/docs/reference/registry-config#version_constraint-version_overrides),
please add not only the latest version but also old versions in `pkg.yaml` to test if old versions can be installed properly.

e.g. [pkg.yaml](pkgs/scaleway/scaleway-cli/pkg.yaml) [registry.yaml](pkgs/scaleway/scaleway-cli/registry.yaml)

```yaml
packages:
  - name: scaleway/scaleway-cli@v2.5.4
  - name: scaleway/scaleway-cli
    version: v2.4.0
```

:warning: Don't use the short syntax `<package name>@<version>` for the old version to prevent Renovate from updating the old version.

:thumbsdown:

```yaml
packages:
  - name: scaleway/scaleway-cli@v2.5.4
  - name: scaleway/scaleway-cli@v2.4.0
```

## How to test in your localhost

```console
$ cp aqua.yaml.tmpl aqua.yaml
$ vi aqua.yaml # Add tested packages
$ aqua i --test
```

## Change `GOOS` and `GOARCH` for testing

Please see https://aquaproj.github.io/docs/reference/change-os-arch-for-test
